# 第七章：回测框架详解

## 学习目标

完成本章节学习后，你将能够理解回测的基本概念和重要性，掌握回测系统的整体架构和工作流程，了解交易成本模型和绩效评估指标的计算方法，以及学会如何解读回测结果并识别潜在问题。预计学习时间为 1.5-2 小时。

## 7.1 回测概述

### 什么是回测

回测（Backtesting）是量化投资策略开发过程中不可或缺的环节。它的核心思想是：如果一个策略在过去有效，那么它未来可能也有效（但不能保证）。回测通过在历史数据上模拟策略的执行，评估策略的历史表现，为投资者提供策略有效性的参考。

在 AI Hedge Fund 系统中，回测框架允许用户在历史数据上测试多智能体投资策略的表现。这有助于用户理解策略在不同市场环境下的表现，识别策略的优势和局限。

### 回测的重要性

回测对于策略开发至关重要。首先，回测提供了一个低成本的方式来评估策略潜力。如果策略在回测中表现不佳，那么在实盘中表现良好的可能性也很低。其次，回测帮助识别策略的问题，如过度拟合、数据偏差等。第三，回测提供了与其他策略或基准比较的基础。第四，回测结果可以作为向他人展示策略有效性的证据。

### 回测的局限性

虽然回测是重要的工具，但它有一些固有的局限性。**历史不代表未来**：市场环境会变化，过去有效的策略未来可能失效。**过拟合风险**：策略可能过度优化于历史数据，缺乏对未来数据的泛化能力。**数据质量问题**：历史数据可能存在错误、缺失或 survivor bias。**忽略执行问题**：回测通常假设理想执行，而现实中存在滑点、流动性限制等。

## 7.2 回测系统架构

### 核心组件

回测系统由以下核心组件构成：

**BacktestEngine**：回测引擎，协调整个回测流程，控制数据获取、策略执行、绩效计算等步骤。

**Portfolio**：投资组合状态管理，跟踪持仓、现金、交易记录等状态。

**TradeExecutor**：交易执行器，模拟订单的执行过程，考虑交易成本和滑点。

**PerformanceMetricsCalculator**：绩效指标计算器，计算各种绩效评估指标。

**AgentController**：智能体控制器，调用智能体生成交易信号。

**OutputBuilder**：输出格式化器，将回测结果格式化为用户可读的形式。

### 回测流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        回测流程                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. 初始化                                                     │
│     ├── 设置初始资金                                             │
│     ├── 设置回测时间范围                                         │
│     ├── 设置交易成本参数                                         │
│     └── 初始化投资组合状态                                        │
│                                                                 │
│  2. 预取历史数据                                                │
│     ├── 获取所有股票的日级价格数据                                 │
│     ├── 获取财务指标数据                                         │
│     └── 缓存数据以加速后续计算                                    │
│                                                                 │
│  3. 遍历交易日                                                  │
│     ┌─────────────────────────────────────────────────────┐   │
│     │ 对于每个交易日：                                       │   │
│     │   ├── 获取当日价格                                     │   │
│     │   ├── 获取 lookback 期间数据                           │   │
│     │   ├── 调用智能体生成交易信号                            │   │
│     │   ├── 执行交易（考虑成本和滑点）                        │   │
│     │   ├── 更新投资组合状态                                  │   │
│     │   └── 计算绩效指标                                     │   │
│     └─────────────────────────────────────────────────────┘   │
│                                                                 │
│  4. 生成报告                                                    │
│     ├── 计算最终绩效指标                                         │
│     ├── 生成权益曲线图                                          │
│     ├── 生成交易记录清单                                        │
│     └── 格式化输出                                              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 7.3 交易成本模型

### 成本类型

真实交易会产生多种成本，回测时必须考虑这些成本才能得到更准确的结果。

**佣金（Commission）**：交易时支付给券商的费用。不同券商的佣金率差异很大，从每股几美分到固定金额不等。系统使用可配置的佣金率，默认值为 0.1%（每 1000 美元交易收取 1 美元）。

**滑点（Slippage）**：实际成交价与预期成交价之间的差异。滑点在市场流动性差或大额交易时尤为明显。系统使用基于波动率的滑点模型：预期滑点 = 订单规模因子 × 波动率因子。

**点差（Spread）**：买入价和卖出价之间的差额。流动性差的股票点差较大，每次交易都会「损失」这个差额。

**市场冲击（Market Impact）**：大额订单本身对市场价格造成的影响。机构投资者的订单尤其需要考虑这一点。

### 成本模型配置

```yaml
# 回测成本配置示例
trading_costs:
  commission:
    type: "percentage"  # 或 "per_share"
    rate: 0.001  # 0.1%
  
  slippage:
    type: "volatility_adjusted"
    base_rate: 0.0005  # 基准滑点率
    volatility_multiplier: 0.1
  
  spread:
    type: "percentage"
    rate: 0.0002  # 0.02%
  
  market_impact:
    type: "linear"
    coefficient: 0.0001  # 每 1% 订单规模的冲击
```

### 成本计算示例

假设交易 1000 股股票，价格 150 美元，佣金率 0.1%，滑点 0.05%：

```
佣金 = 1000 × 150 × 0.1% = 150 美元
滑点 = 1000 × 150 × 0.05% = 75 美元
总成本 = 150 + 75 = 225 美元
```

## 7.4 绩效评估指标

### 收益指标

**总收益率**：投资期间内的总盈亏比例。

```
总收益率 = (期末价值 - 期初价值) / 期初价值
```

**年化收益率**：将不同时间长度的投资表现标准化为年度基准。

```
年化收益率 = (1 + 总收益率)^(365/投资天数) - 1
```

### 风险指标

**波动率**：收益的标准差年化值。

```
年化波动率 = 日波动率 × √252
```

**最大回撤**：从峰值到谷值的最大跌幅。

### 风险调整后收益指标

**夏普比率**：已在前文详细说明。

**索提诺比率（Sortino Ratio）**：只考虑下行波动的夏普比率变体。

```
索提诺比率 = (投资组合收益率 - 目标收益率) / 下行标准差
```

**卡玛比率（Calmar Ratio）**：年化收益与最大回撤的比值。

```
卡玛比率 = 年化收益率 / |最大回撤|
```

### 交易统计指标

**胜率**：盈利交易占总交易次数的比例。

**盈亏比**：平均盈利金额与平均亏损金额的比值。

**交易频率**：单位时间内的交易次数。

## 7.5 回测结果解读

### 报告结构

回测报告通常包含以下部分：

```
============================================================
                    Backtest Results Report
============================================================

Configuration:
- Tickers: AAPL, MSFT, GOOGL
- Period: 2020-01-01 to 2024-01-01
- Initial Capital: $100,000
- Rebalancing: Monthly

============================================================
                       Performance Summary
============================================================

Total Return:              85.23%
Annualized Return:        14.27%
Sharpe Ratio:             0.85
Sortino Ratio:            1.12
Maximum Drawdown:        -18.52%
Volatility (annual):      19.8%

============================================================
                      Monthly Returns
============================================================

Year    Jan   Feb   Mar   Apr   May   Jun   Jul   Aug   Sep   Oct   Nov   Dec    YTD
------------------------------------------------------------------------------------------------
2020   2.1%  -3.2%  5.8%  8.2%  3.1%  -1.5%  4.2%  6.1%  -2.8%  2.5%   5.3%   3.8%   38.5%
2021   1.5%   2.8%  1.2%  3.5%  0.8%   2.1%  -0.5%  4.2%  -1.8%  1.5%   -2.1%  2.3%   16.8%
...
```

### 关键指标解读

**年化收益率 vs 总收益率**：年化收益率消除了时间长度的影响，便于不同时间长度的策略比较。

**夏普比率的解读**：夏普比率大于 1 表示风险调整后收益良好；大于 2 表示非常优秀；小于 0 表示表现不如无风险资产。

**最大回撤的重要性**：最大回撤决定了投资者需要承受的最大痛苦。即使年化收益很高，如果最大回撤过大，普通投资者可能无法坚持执行策略。

### 常见陷阱识别

**幸存者偏差（Survivor Bias）**：如果只使用当前存在的股票进行回测，就会高估策略的有效性。

**前视偏差（Look-Ahead Bias）**：在回测中使用了在实际交易时不可能获得的信息。

**过度拟合（Overfitting）**：策略过度优化于历史数据，缺乏对未来数据的泛化能力。

**交易成本低估**：低估真实交易成本会导致过于乐观的回测结果。

## 7.6 使用回测系统

### 基本命令

```bash
# 基本回测
poetry run python src/backtester.py --ticker AAPL,MSFT,NVDA

# 带参数回测
poetry run python src/backtester.py \
    --ticker AAPL,MSFT,NVDA \
    --start-date 2020-01-01 \
    --end-date 2024-01-01 \
    --initial-capital 100000 \
    --rebalance-frequency monthly

# 带交易成本回测
poetry run python src/backtester.py \
    --ticker AAPL \
    --commission-rate 0.001 \
    --slippage 0.0005
```

### 输出解读

回测完成后，系统会输出详细的绩效报告，包括收益统计、风险指标、月度收益分解、最大回撤分析等。关键指标以表格和图表形式展示，便于快速理解策略表现。

## 7.7 练习题

### 练习 7.1：基础回测

**任务**：运行一个基础回测并解读结果。

**步骤**：首先运行 AAPL 的 3 年回测，然后记录关键绩效指标，接着绘制权益曲线并分析，最后识别最大回撤发生的时间段。

**要求**：撰写简要的回测报告，包含所有关键指标和分析发现。

### 练习 7.2：交易成本影响分析

**任务**：比较不同交易成本设置下的回测结果。

**实验设计**：分别以 0%、0.05%、0.1%、0.2% 的佣金率运行相同策略的回测，比较各成本下的收益差异。

**要求**：量化交易成本对收益的影响，提出最优成本假设。

### 练习 7.3：策略稳健性检验

**任务**：检验策略在不同市场环境下的表现。

**实验设计**：分别在牛市期间（2020 年）、震荡市期间（2021-2022）、熊市期间（2022 年）运行回测。

**要求**：分析策略在不同市场环境下的表现差异，评估策略的稳健性。

---

## 进阶思考

思考以下问题。如何设计能够区分「真正有效」和「过度拟合」的回测实验？机器学习技术（如时间序列交叉验证）如何改进传统的回测方法？如何在回测中更好地模拟真实市场环境，如流动性限制和交易冲击？

下一章节我们将学习 LLM 集成的架构设计和提示词工程。

---

## 版本信息

| 项目 | 信息 |
|------|------|
| 文档版本 | 1.0.2 |
| 最后更新 | 2026年2月 |
| 适用版本 | 1.0.0+ |

**更新日志**：
- v1.0.2 (2026.02)：完善回测结果解读，增加索提诺比率说明
- v1.0.1 (2025.12)：增加交易成本影响分析
- v1.0.0 (2025.10)：初始版本

## 反馈与贡献

如果您在阅读过程中发现问题或有改进建议，欢迎通过 GitHub Issues 提交反馈。
