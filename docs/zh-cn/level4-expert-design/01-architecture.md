# 第一章：核心架构解析

## 学习目标

完成本章节学习后，你将能够深入理解系统的整体架构设计和决策过程，掌握各核心模块的职责和交互方式，理解架构决策背后的权衡和考量，以及能够基于架构知识进行深度定制和扩展。预计学习时间为 3-4 小时。

## 1.1 系统架构总览

### 架构设计原则

AI Hedge Fund 系统采用分层架构设计，遵循关注点分离、依赖倒置、模块化等经典软件工程原则。系统的整体架构可以分为五个层次：表现层负责用户交互，包括命令行界面和 Web 应用界面。应用层协调工作流程，包括分析任务调度、回测执行、报告生成等。智能体层封装了 18 个专业化智能体，每个智能体负责特定的分析任务。服务层提供基础服务能力，包括 LLM 调用、数据获取、缓存管理、风险管理等。数据层管理数据持久化和访问，包括缓存层和持久化存储。

### 核心组件关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              表现层                                          │
│  ┌─────────────────────┐              ┌─────────────────────┐           │
│  │    CLI (main.py)    │              │   Web (FastAPI)     │           │
│  └──────────┬──────────┘              └──────────┬──────────┘           │
└─────────────┼───────────────────────────────────────┼─────────────────────┘
              │                                       │
              ▼                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                          │
│  ┌─────────────────────┐              ┌─────────────────────┐           │
│  │  AnalysisWorkflow   │              │   BacktestEngine    │           │
│  │  (LangGraph编排)    │              │   (回测执行)        │           │
│  └──────────┬──────────┘              └──────────┬──────────┘           │
└─────────────┼───────────────────────────────────────┼─────────────────────┘
              │                                       │
              ▼                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            智能体层                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐ │
│  │                    Agent Ecosystem (18 Agents)                        │ │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐  │ │
│  │  │ Buffett │ │  Graham │ │  Lynch  │ │  Wood   │ │ RiskMgr │  │ │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘  │ │
│  └─────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────────┘
              │
              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              服务层                                          │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐│
│  │   LLM服务    │ │  数据服务    │ │  风控服务    │ │   组合优化服务      ││
│  │ (LangChain) │ │ (Financial  │ │ (RiskMgr)  │ │ (Portfolio)        ││
│  │             │ │  Datasets)  │ │             │ │                     ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘│
└─────────────────────────────────────────────────────────────────────────────┘
```

## 1.2 核心模块详解

### 智能体系统架构

智能体是系统的核心创新点。每个智能体都遵循统一的接口规范，但内部实现各有特色。以沃伦·巴菲特智能体为例，其内部结构可以分为三个层次：数据获取层负责从服务层获取财务数据、市场数据等原始信息。分析引擎层使用 LLM 进行推理分析，结合规则化的筛选条件生成分析结果。输出格式化层将 LLM 的非结构化输出转换为标准化的信号格式。

```python
class WarrenBuffettAgent(BaseAgent):
    """
    沃伦·巴菲特风格智能体
    
    核心特点：
    - 关注经济护城河分析
    - 重视自由现金流评估
    - 使用相对保守的估值方法
    """
    
    # 分析维度配置
    ANALYSIS_DIMENSIONS = [
        "moat_analysis",       # 护城河分析
        "free_cash_flow",      # 自由现金流
        "management_quality",  # 管理质量
        "intrinsic_value",     # 内在价值
        "margin_of_safety"     # 安全边际
    ]
    
    def analyze(self, ticker: str, data: Dict) -> AgentSignal:
        # 1. 数据准备
        financial_data = self._prepare_financial_data(data)
        
        # 2. 量化筛选（格雷厄姆式筛选）
        meets_graham_criteria = self._apply_graham_filter(financial_data)
        
        # 3. 护城河评估
        moat_score = self._assess_moat(financial_data)
        
        # 4. 内在价值计算
        intrinsic_value = self._calculate_intrinsic_value(financial_data)
        
        # 5. LLM 综合分析
        analysis_result = self._llm_analyze({
            "financial_metrics": financial_data,
            "moat_score": moat_score,
            "intrinsic_value": intrinsic_value,
            "meets_graham": meets_graham_criteria
        })
        
        # 6. 生成信号
        return self._generate_signal(analysis_result)
```

### LangGraph 工作流引擎

LangGraph 是系统工作流编排的核心框架。系统使用状态图来定义智能体的协作流程，每个节点代表一个计算单元，边代表数据和控制流动的方向。

```python
def create_analysis_workflow(
    selected_agents: List[str],
    config: WorkflowConfig
) -> StateGraph:
    """
    创建分析工作流
    
    工作流结构：
    1. start_node: 初始化，收集数据
    2. parallel_agents: 并行执行选中的智能体
    3. risk_management: 风险管理分析
    4. portfolio_optimization: 投资组合优化
    5. output_generation: 生成最终输出
    """
    
    workflow = StateGraph(AgentState)
    
    # 添加节点
    workflow.add_node("start", initialize_analysis)
    
    # 添加并行智能体节点
    agent_nodes = create_agent_nodes(selected_agents)
    for node_name, node_func in agent_nodes.items():
        workflow.add_node(node_name, node_func)
        workflow.add_edge("start", node_name)
    
    # 添加风险管理节点
    workflow.add_node("risk_management", risk_management_agent)
    for node_name in agent_nodes.keys():
        workflow.add_edge(node_name, "risk_management")
    
    # 添加投资组合优化节点
    workflow.add_node("portfolio_optimization", portfolio_optimization_agent)
    workflow.add_edge("risk_management", "portfolio_optimization")
    
    # 添加输出生成节点
    workflow.add_node("output", generate_final_output)
    workflow.add_edge("portfolio_optimization", "output")
    
    # 设置入口和出口
    workflow.set_entry_point("start")
    workflow.set_finish_point("output")
    
    return workflow
```

### 决策流程深度解析

一次完整的分析决策流程经历以下阶段：

**阶段一：初始化**。这个阶段的工作包括接收用户请求并解析参数，验证股票代码和时间范围的合法性，检查 API 密钥配置是否有效，以及预取必要的配置信息。

**阶段二：数据收集**。这个阶段的工作包括从金融数据 API 获取价格数据，从财务数据库获取财务指标，从新闻 API 获取公司新闻，从缓存层检查是否有可用的历史数据。

**阶段三：并行分析**。这个阶段的工作是系统的核心，18 个智能体并行工作，每个智能体接收相同的数据上下文，独立进行推理分析。LangGraph 自动调度并行执行，汇总结果。

**阶段四：风险评估**。这个阶段的工作包括汇总所有智能体的信号，评估整体风险水平，计算推荐的仓位大小，设置止损和获利了结参数。

**阶段五：组合优化**。这个阶段的工作包括根据风险评估结果优化资产配置，计算最优仓位分配，考虑分散化约束和交易成本。

**阶段六：输出生成**。这个阶段的工作包括格式化最终输出，生成详细的分析报告，保存结果到历史记录。

## 1.3 数据流分析

### 主数据流

```
用户请求
    │
    ▼
┌─────────────────────┐
│   请求验证/路由      │ ← 参数验证、缓存检查
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   数据预取          │ ← 并行获取价格、财务、新闻数据
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   智能体并行分析     │ ← 18 个智能体并行推理
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   结果汇总          │ ← 聚合各智能体信号
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   风险评估          │ ← VaR、仓位、止损计算
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   组合优化          │ ← 最优配置生成
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   输出格式化        │ ← 生成报告、API响应
└──────────┬──────────┘
           │
           ▼
结果返回/缓存保存
```

### 缓存层级

系统实现三级缓存架构以优化性能和降低成本。

**L1 内存缓存**位于进程内存中，用于存储当前请求周期内频繁访问的数据，如配置信息、模型参数等。特点是访问速度最快，容量有限，与进程生命周期绑定。

**L2 Redis 缓存**位于分布式缓存中，用于存储跨进程共享的数据，如预取的股票数据。特点是访问速度快，支持分布式共享，可以设置 TTL 自动过期。

**L3 磁盘缓存**位于本地磁盘，用于存储大型数据集和回测结果。特点是持久化存储，容量最大，访问速度相对较慢。

## 1.4 架构决策记录

### ADR 001：采用 LangGraph 作为工作流引擎

**决策**：选择 LangGraph 作为智能体协作的工作流引擎。

**背景**：系统需要编排 18 个智能体的并行执行和结果汇总，需要支持条件分支和动态工作流。

**考量因素**：LangGraph 与 LangChain 无缝集成，支持复杂的状态管理，具有良好的可视化能力，社区活跃度高。

**替代方案**：Temporal（过于复杂）、Airflow（面向批处理）、自定义实现（维护成本高）。

**决定**：采用 LangGraph，其声明式的状态图模型非常适合本系统的需求。

### ADR 002：统一智能体接口

**决策**：所有智能体必须实现统一的接口规范。

**背景**：不同投资风格的智能体需要以一致的方式被调用和组合。

**考量因素**：统一接口简化了工作流编排，提高了系统的可测试性和可维护性。

**决定**：定义 `BaseAgent` 抽象类，包含 `analyze()`、`get_prompt()`、`parse_response()` 三个核心方法。

### ADR 003：分离配置与代码

**决策**：将提示词、配置参数、外部化为 YAML 文件。

**背景**：提示词需要频繁调整以优化分析质量，频繁修改代码不利于版本管理。

**考量因素**：外部化配置便于非程序员调整系统行为，支持多环境配置切换。

**决定**：所有提示词模板存储在 `config/prompts/` 目录，遵循 `{agent_id}.yaml` 命名规范。

## 1.5 练习题

### 练习 1.1：架构分析报告

**任务**：撰写一份详细的核心架构分析报告。

**要求**：包含系统整体架构图，详细说明各层次的职责，描述核心数据流，分析架构决策的权衡。

### 练习 1.2：工作流定制

**任务**：设计并实现一个定制化的分析工作流。

**步骤**：首先定义新的工作流配置，然后实现自定义节点逻辑，接着集成到系统中，最后测试验证。

### 练习 1.3：性能评估

**任务**：对系统进行性能评估并提出优化建议。

**步骤**：首先建立性能基准测试，然后识别性能瓶颈，接着分析根因，最后提出优化方案。

---

## 版本信息

| 项目 | 信息 |
|------|------|
| 文档版本 | 1.0.1 |
| 最后更新 | 2026年2月 |
| 适用版本 | 1.0.0+ |

**更新日志**：
- v1.0.1 (2026.02)：更新架构图，增加 ADR 决策记录
- v1.0.0 (2025.10)：初始版本

## 反馈与贡献

如果您在阅读过程中发现问题或有改进建议，欢迎通过 GitHub Issues 提交反馈。
