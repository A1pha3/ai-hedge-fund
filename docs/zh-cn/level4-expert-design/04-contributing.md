# 第四章：贡献者指南

## 学习目标

完成本章节学习后，你将能够理解项目的贡献流程和规范，掌握代码提交、Pull Request 创建和代码审查的最佳实践，了解测试和质量保证要求，以及能够成为项目的活跃贡献者。预计学习时间为 2-3 小时。

## 4.1 贡献流程概述

### 贡献类型

项目接受多种类型的贡献，包括代码贡献、文档贡献、问题报告、功能请求、翻译贡献等。每种贡献都有相应的流程和要求。

**代码贡献**是最常见的贡献类型，包括新功能开发、Bug 修复、性能优化、代码重构等。代码贡献需要遵循项目的编码规范，编写测试，并通过代码审查。

**文档贡献**包括修复文档错误、添加新文档、改进现有文档、翻译文档等。文档贡献相对简单，但同样需要遵循文档规范。

**问题报告**帮助我们发现和修复系统中的问题。高质量的问题报告应包含复现步骤、环境信息、预期行为和实际行为。

**功能请求**是对新功能的建议。好的功能请求应说明需求背景、使用场景和预期效果。

### 贡献流程

```
1. Fork 项目仓库
   │
   ▼
2. 创建功能分支
   │
   ▼
3. 开发并测试
   │
   ▼
4. 提交更改
   │
   ▼
5. 创建 Pull Request
   │
   ▼
6. 代码审查
   │
   ▼
7. 合并到主分支
```

## 4.2 开发环境设置

### Fork 仓库

首先，将项目 fork 到你自己的 GitHub 账户：

```bash
# 访问 https://github.com/virattt/ai-hedge-fund
# 点击 Fork 按钮

# 克隆你的 fork
git clone https://github.com/YOUR_USERNAME/ai-hedge-fund.git
cd ai-hedge-fund

# 添加上游仓库
git remote add upstream https://github.com/virattt/ai-hedge-fund.git

# 验证远程配置
git remote -v
# 应该显示：
# origin    https://github.com/YOUR_USERNAME/ai-hedge-fund.git (fetch)
# origin    https://github.com/YOUR_USERNAME/ai-hedge-fund.git (push)
# upstream  https://github.com/virattt/ai-hedge-fund.git (fetch)
# upstream  https://github.com/virattt/ai-hedge-fund.git (push)
```

### 设置开发环境

```bash
# 创建分支
git checkout -b feature/your-feature-name

# 安装依赖
poetry install

# 安装 pre-commit 钩子
pre-commit install

# 运行测试确保环境正确
pytest tests/ -v
```

### 同步上游更改

```bash
# 获取上游更改
git fetch upstream

# 合并到你的主分支
git checkout main
git merge upstream/main

# 同步到你的 fork
git push origin main
```

## 4.3 代码提交规范

### 提交信息格式

```
<类型>(<范围>): <描述>

[可选的正文]

[可选的脚注]
```

**类型**：

`feat` 表示新功能。

`fix` 表示 Bug 修复。

`docs` 表示文档更改。

`style` 表示代码格式更改（不影响代码含义）。

`refactor` 表示代码重构（既不是新功能也不是 Bug 修复）。

`perf` 表示性能优化。

`test` 表示添加或修改测试。

`chore` 表示构建过程或辅助工具的更改。

**范围**：受影响的模块，如 `agents`、`data`、`workflow` 等。

**示例**：

```
feat(agents): 添加沃伦·巴菲特智能体的护城河分析

实现了经济护城河的量化评估功能，包括：
- 品牌价值评估
- 网络效应分析
- 转换成本评估

Closes #123
```

### 提交前检查

```bash
# 运行代码检查
black src/agents/
isort src/agents/
flake8 src/agents/

# 运行类型检查
mypy src/agents/

# 运行测试
pytest tests/agents/ -v

# 运行集成测试
pytest tests/integration/ -v
```

## 4.4 Pull Request 创建

### PR 模板

```markdown
## 描述
<!-- 简要描述你的更改 -->

## 更改类型
- [ ] Bug 修复
- [ ] 新功能
- [ ] 文档更新
- [ ] 代码重构
- [ ] 性能优化
- [ ] 测试更新

## 测试
- [ ] 我添加了新的测试
- [ ] 所有测试都通过
- [ ] 我手动测试了更改

## 清单
- [ ] 我的代码遵循项目的编码规范
- [ ] 我的更改需要更新文档
- [ ] 我的更改不会破坏现有功能
- [ ] 我已阅读并同意贡献者协议
```

### PR 描述示例

```markdown
## 描述

添加 ESG 投资风格的智能体，专注于环境、社会责任和公司治理因素的分析。

### 新增功能

1. **ESG Analyst Agent**
   - 环境因素评估（碳排放、资源使用、污染等）
   - 社会责任分析（员工关系、社区参与、产品安全等）
   - 公司治理评估（董事会结构、高管薪酬、股东权利等）

2. **ESG 评分模型**
   - 综合 ESG 评分计算
   - 行业基准对比
   - 趋势分析

### 测试覆盖

- 单元测试：8 个测试用例
- 集成测试：2 个测试场景
- 手动测试：通过

### 相关 Issue

- Closes #45
- Related to #30
```

## 4.5 代码审查指南

### 审查者职责

**及时响应**：在 24 小时内响应 PR。

**全面审查**：检查功能正确性、代码质量、性能影响、文档更新等。

**提供建设性反馈**：给出具体、可操作的建议，而非模糊的批评。

**区分必需和可选**：区分必须修改的问题和可以讨论的建议。

### 审查清单

```markdown
## 功能正确性
- [ ] 代码是否正确实现了需求？
- [ ] 边界情况是否处理？
- [ ] 错误处理是否完善？

## 代码质量
- [ ] 代码是否清晰易读？
- [ ] 是否有不必要的复杂性？
- [ ] 是否遵循项目编码规范？

## 性能影响
- [ ] 是否有性能问题？
- [ ] 是否需要性能测试？

## 测试覆盖
- [ ] 是否有足够的测试？
- [ ] 测试是否有效？

## 文档和注释
- [ ] 是否有必要的文档更新？
- [ ] 复杂逻辑是否有注释？

## 安全性
- [ ] 是否有安全漏洞？
- [ ] 是否正确处理敏感信息？
```

### 常见审查反馈

```markdown
### 需要修改（Must Fix）

1. **功能错误**
   ```
   这段代码的逻辑有问题。当 X 发生时，应该执行 Y，但当前实现执行了 Z。
   
   建议修改：
   ```python
   # 当前代码
   if condition:
       do_something_wrong()
   
   # 建议修改
   if condition:
       do_something_correct()
   ```
   ```

2. **代码规范违反**
   ```
   请使用项目的编码规范。变量命名应该使用 snake_case。
   
   当前：`varName = value`
   应改为：`var_name = value`
   ```

### 建议修改（Should Consider）

1. **可读性改进**
   ```
   这段代码可以简化，提高可读性：
   
   当前：
   ```python
   if a is not None and b is not None and c is not None:
       do_something()
   ```
   
   建议：
   ```python
   if all([a, b, c]):
       do_something()
   ```

2. **性能考虑**
   ```
   这个循环可能会在大数据集上性能不佳。建议使用列表推导式或生成器。
   ```

### 讨论点（Discussion）

1. **设计决策**
   ```
   这里的设计决策可能需要更多讨论。当前的实现选择了方案 A，
   但方案 B 可能更适合长期维护。请分享你的想法。
   ```

2. **替代方案**
   ```
   我想到了一个可能的替代实现，可能会更简洁。
   我们可以讨论一下优缺点。
   ```
```

## 4.6 贡献者协议

### 贡献者许可协议

通过向本项目贡献代码，你同意以下条款：

**版权声明**：你拥有你贡献的代码的版权，但你授予项目永久的、不可撤销的、全球范围的、免版税的、非排他性的许可，允许项目使用、复制、修改、分发你的贡献。

**代码来源**：你声明你有权按照上述条款授予许可，你贡献的代码没有侵犯任何第三方的知识产权。

**原创声明**：你声明你贡献的代码是你原创的，或者你有权按照上述条款贡献第三方代码。

### 行为准则

作为贡献者，我们承诺：

**欢迎**：欢迎所有类型的贡献，无论经验水平如何。

**包容**：创建一个包容的环境，让所有人都能参与。

**尊重**：尊重不同的观点和经历。

**建设性**：提供建设性的反馈，而非批评。

## 4.7 自动化测试

### 测试要求

所有 PR 必须通过以下测试：

```bash
# 单元测试
pytest tests/unit/ -v --cov=src --cov-report=html

# 集成测试
pytest tests/integration/ -v

# 端到端测试
pytest tests/e2e/ -v

# 类型检查
mypy src/

# 代码格式检查
black --check src/
flake8 src/
isort --check-only src/
```

### 测试覆盖率要求

- 新功能的代码覆盖率不低于 80%
- 整体代码覆盖率不低于 70%
- 关键模块的代码覆盖率达到 90%

## 4.8 练习题

### 练习 4.1：第一个贡献

**任务**：完成你的第一个代码贡献。

**步骤**：首先 fork 项目并设置开发环境，然后修复一个小问题（如文档错误、代码格式问题等），接着提交 PR，最后响应审查反馈。

**要求**：遵循所有提交规范，PR 描述完整清晰，通过所有自动化测试。

### 练习 4.2：代码审查实践

**任务**：审查一个示例 PR。

**步骤**：首先阅读 PR 内容和代码更改，然后检查功能正确性，接着评估代码质量和测试覆盖，最后提供建设性反馈。

### 练习 4.3：贡献者社区参与

**任务**：参与贡献者社区。

**步骤**：首先回答其他贡献者的问题，然后审查其他贡献者的 PR，接着参与功能设计讨论，最后分享你的经验和最佳实践。
